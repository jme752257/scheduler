<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Weekly Scheduler</title><style>:root{--bg:#0f1115;--panel:#141820;--ink:#e7eaf0;--muted:#7b8191;--accent:#4f8cff;--grid:#262b36;--hour-height:48px;--radius:16px}*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial;color:var(--ink);background:linear-gradient(180deg,#0c0e13,#0f1115 30%)}.app{max-width:1200px;margin:16px auto;padding:12px;border-radius:18px;background:var(--panel);box-shadow:0 10px 30px rgba(0,0,0,.35)}.toolbar{display:flex;align-items:center;gap:10px;padding:8px 8px 12px;border-bottom:1px solid var(--grid)}.toolbar h1{font-size:18px;font-weight:600;margin:0 8px 0 0;color:#cdd3df}.spacer{flex:1}button,.btn{border:1px solid #2b3240;background:#171c25;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;line-height:1;font-weight:600;transition:.15s ease}button:hover{filter:brightness(1.15)}button.primary{background:var(--accent);border-color:transparent;color:#fff}.weekbar{display:flex;gap:6px;align-items:center}.weeklabel{min-width:240px;text-align:center;color:#dfe5f4;font-weight:700}.grid{display:grid;grid-template-columns:64px repeat(7,1fr);gap:0;overflow:auto;height:calc(100vh - 200px)}.dayheader,.timecol-label{position:sticky;top:0;z-index:5;background:var(--panel);border-bottom:1px solid var(--grid)}.timecol-label{height:44px}.dayheader{height:44px;display:flex;align-items:center;justify-content:center;border-left:1px solid var(--grid)}.dayheader .weekday{font-size:12px;color:var(--muted);margin-right:6px}.dayheader .datechip{padding:4px 8px;border-radius:999px;background:#1b2230;color:#dbe1ef}.dayheader .datechip.today{background:var(--accent);color:#fff}.timecol{border-right:1px solid var(--grid)}.time{height:var(--hour-height);padding-right:8px;display:flex;justify-content:flex-end;align-items:flex-start;color:var(--muted);font-size:12px}.daygrid{position:relative;height:calc(24 * var(--hour-height));border-left:1px solid var(--grid)}.slot{position:absolute;left:0;right:0;border-top:1px solid rgba(255,255,255,.04);height:var(--hour-height)}.slot.half{border-top-style:dashed;opacity:.45}.nowline{position:absolute;left:0;right:0;height:2px;background:var(--accent);box-shadow:0 0 8px rgba(79,140,255,.8);z-index:3}.event{position:absolute;left:6px;right:6px;border-radius:12px;padding:6px 8px 14px;background:linear-gradient(180deg,#334bff2b,#4f8cff40);border:1px solid rgba(79,140,255,.35);color:#eaf1ff;backdrop-filter:blur(2px);box-shadow:0 8px 20px rgba(0,0,0,.25);cursor:grab;overflow:hidden;user-select:none;transition:box-shadow .18s,filter .18s}.event:hover:not(.dragging){box-shadow:0 14px 28px rgba(0,0,0,.35),0 0 0 1px rgba(79,140,255,.2) inset;filter:brightness(1.06) saturate(1.05)}.event.dragging{opacity:.9;box-shadow:0 0 0 1px rgba(79,140,255,.25) inset,0 10px 24px rgba(0,0,0,.28)}.event.selected{box-shadow:0 0 0 2px rgba(79,140,255,.5),0 12px 26px rgba(0,0,0,.3)}.event .title{font-size:13px;font-weight:400}.event .subtitle{font-size:11px;color:#e4e8f680}.event.edge-top,.event.edge-bottom{cursor:ns-resize}.event.short15{padding:2px 6px}.event.short15 .title-row,.event.short15 .title,.event.short15 .time-inline{line-height:1}.tip{color:var(--muted);font-size:12px;padding:8px 8px 0}dialog{border:none;padding:0;background:transparent}dialog::backdrop{background:rgba(10,14,22,.58);-webkit-backdrop-filter:blur(1.2px);backdrop-filter:blur(1.2px)}.modal{position:relative;width:min(640px,96vw);background:#11161f;border:1px solid #283142;border-radius:16px;box-shadow:0 14px 50px rgba(0,0,0,.6);overflow:hidden;isolation:isolate;clip-path:inset(0 round 16px)}.modal .content{padding:28px 18px 16px;display:grid;grid-template-columns:1fr 1fr;gap:12px}.modal .modal-close{position:absolute;top:12px;right:12px;z-index:3}.divider{grid-column:1/-1;height:1px;background:#232b39;opacity:.8;margin:2px 0 8px}.row.full{grid-column:1/-1;display:flex;flex-direction:column;gap:6px}.softlabel{font-size:13px;color:rgba(231,234,240,.6);font-weight:400}.input-ghost{background:#0f141c;border:1px solid #202838;border-radius:12px;padding:14px;color:var(--ink)}.input-ghost.big{font-size:20px;font-weight:400;background:transparent;border:0;padding:8px 10px 2px 14px;color:#dfe5f4}#title:focus{outline:none!important;box-shadow:none!important;border-color:transparent!important;background:transparent!important}.dt-row{grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:12px}.dt-card{background:#0f141c;border:1px solid #202838;border-radius:12px;padding:10px 12px}.dt-label{font-size:12px;color:rgba(231,234,240,.6);margin-bottom:6px;font-weight:400}.dt-body{display:flex;align-items:center;gap:10px}.dt-input{background:transparent;border:none;color:#b9c3d6;font-size:14px;width:100%;padding:6px 0}.dt-input:focus{outline:none}.modal footer{padding:16px 18px;border-top:1px solid var(--grid);display:flex;justify-content:flex-end;gap:8px}.modal input[type=datetime-local]::-webkit-calendar-picker-indicator{opacity:.6;filter:grayscale(1) brightness(1.05)}.modal input[type=datetime-local]:hover::-webkit-calendar-picker-indicator{opacity:.75}#deleteBtn{font-size:16px;padding:16px 26px;border-radius:12px;min-width:240px;background:#1a1f2b;border:1px solid #3a4456;color:#e7eaf0;margin-right:auto}#saveBtn{font-size:16px;padding:16px 26px;border-radius:12px;min-width:240px}#saveBtn.primary{background:#3a4f77;border-color:#3a4f77;color:#e8eefc}#saveBtn.primary:hover{filter:brightness(1.08)}#deleteBtn.confirm{filter:brightness(1.06);box-shadow:0 0 0 2px rgba(79,140,255,.12)}input[type=datetime-local]{padding-right:8px;color:#c9d2e3}.closebtn{position:relative;width:44px;height:44px;background:transparent;border:none;color:#cfd8e3;cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center}.closebtn::before,.closebtn::after{content:"";position:absolute;left:12px;right:12px;top:50%;height:1.5px;background:#cfd8e3;border-radius:1px;transform-origin:50% 50%}.closebtn::before{transform:rotate(45deg)}.closebtn::after{transform:rotate(-45deg)}.closebtn:hover::before,.closebtn:hover::after{background:#fff}.grid{scrollbar-color:#3a4456 #0f141c;scrollbar-width:thin}body{scrollbar-color:#3a4456 #0c0e13;scrollbar-width:thin}.grid::-webkit-scrollbar{width:12px;height:12px}.grid::-webkit-scrollbar-track{background:#0f141c;border-left:1px solid #2a3241}.grid::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#2a3241,#3a4456);border:3px solid #0f141c;border-radius:10px}.grid::-webkit-scrollbar-thumb:hover{background:#4f8cff}.grid::-webkit-scrollbar-corner{background:#0f141c}body::-webkit-scrollbar{width:12px}body::-webkit-scrollbar-track{background:#0c0e13}body::-webkit-scrollbar-thumb{background:#2a3241;border-radius:10px}@media(max-width:840px){.grid{grid-template-columns:44px repeat(7,1fr)}.modal .content{grid-template-columns:1fr}.weeklabel{min-width:auto}}</style></head><body><div class="app"><div class="toolbar"><h1>Scheduler</h1><div class="weekbar"><button id="prevWeek" aria-label="Previous week">◀</button><button id="todayBtn" class="today">Today</button><button id="nextWeek" aria-label="Next week">▶</button></div><div class="weeklabel" id="weekLabel">Week</div><div class="spacer"></div><button id="addEvent" class="primary">+ New event</button></div><div class="tip">Double‑click an event to edit or delete. Drag to move and resize from the top/bottom edge. Snaps to 15 minutes.</div><div class="grid" id="grid"><div class="timecol-label"></div><div class="dayheader" data-day="0"></div><div class="dayheader" data-day="1"></div><div class="dayheader" data-day="2"></div><div class="dayheader" data-day="3"></div><div class="dayheader" data-day="4"></div><div class="dayheader" data-day="5"></div><div class="dayheader" data-day="6"></div><div class="timecol" id="timecol"></div><div class="daygrid" data-day="0"></div><div class="daygrid" data-day="1"></div><div class="daygrid" data-day="2"></div><div class="daygrid" data-day="3"></div><div class="daygrid" data-day="4"></div><div class="daygrid" data-day="5"></div><div class="daygrid" data-day="6"></div></div></div><dialog id="eventDialog"><form method="dialog" class="modal" id="eventForm"><button type="button" id="closeBtn" class="closebtn modal-close" aria-label="Close"></button><div class="content"><div class="row full title-row"><input id="title" class="input-ghost big" name="title" type="text" placeholder="Give your event a name" aria-label="Event title"/></div><div class="divider"></div><div class="dt-row"><div class="dt-card"><div class="dt-label">Start</div><div class="dt-body"><input id="startDT" class="dt-input" name="startDT" type="datetime-local" step="900" required/></div></div><div class="dt-card"><div class="dt-label">End</div><div class="dt-body"><input id="endDT" class="dt-input" name="endDT" type="datetime-local" step="900" required/></div></div></div><div class="divider"></div><div class="row full"><label class="softlabel" for="location">Location</label><input id="location" class="input-ghost" name="location" type="text" placeholder="Type a location (optional)"/></div><div class="divider"></div><div class="row full"><label class="softlabel" for="description">Event Description</label><textarea id="description" class="input-ghost" name="description" placeholder="Type your event description here"></textarea></div></div><footer><button type="button" class="danger" id="deleteBtn" style="display:none">Delete</button><button type="submit" class="primary" id="saveBtn">Create meeting</button></footer></form></dialog><script>document.addEventListener('DOMContentLoaded',()=>{const HOUR_PX=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--hour-height'));const SNAP_MIN=15;const gridEl=document.getElementById('grid');const weekLabel=document.getElementById('weekLabel');let state={weekStart:startOfWeek(new Date()),events:loadEvents(),editingId:null,selectedId:null,clipboard:null};function startOfWeek(d){const x=new Date(d),day=(x.getDay()+6)%7;x.setHours(0,0,0,0);x.setDate(x.getDate()-day);return x}function pad(n){return(n<10?'0':'')+n}function toLocalInputValue(d){const x=new Date(d);return`${x.getFullYear()}-${pad(x.getMonth()+1)}-${pad(x.getDate())}T${pad(x.getHours())}:${pad(x.getMinutes())}`}function dateKeyLocal(d){return`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}function minutesSinceMidnight(d){return d.getHours()*60+d.getMinutes()}function yFromMinutes(m){return(m/60)*HOUR_PX}function snap(m){return Math.round(m/SNAP_MIN)*SNAP_MIN}function dateFromDayAndMinutes(day,mins){const d=new Date(day);d.setHours(0,0,0,0);d.setMinutes(mins);return d}function loadEvents(){try{return JSON.parse(localStorage.getItem('schedulerEventsV1')||'[]')}catch(e){return[]}}function saveEvents(){localStorage.setItem('schedulerEventsV1',JSON.stringify(state.events))}function renderToolbar(){const end=new Date(state.weekStart);end.setDate(end.getDate()+6);const f1=new Intl.DateTimeFormat(undefined,{month:'long',day:'numeric'}),f2=new Intl.DateTimeFormat(undefined,{year:'numeric'});weekLabel.textContent=`${f1.format(state.weekStart)} – ${f1.format(end)} ${f2.format(end)}`}function renderHeaders(){const headers=gridEl.querySelectorAll('.dayheader'),now=new Date();headers.forEach((h,i)=>{const d=new Date(state.weekStart);d.setDate(d.getDate()+i);const weekday=new Intl.DateTimeFormat(undefined,{weekday:'short'}).format(d),dateNum=d.getDate(),today=dateKeyLocal(d)===dateKeyLocal(now)?'today':'';h.innerHTML=`<span class="weekday">${weekday}</span><span class="datechip ${today}">${dateNum}</span>`})}function renderTimeColumn(){const timecol=document.getElementById('timecol');timecol.innerHTML='';for(let h=0;h<24;h++){const div=document.createElement('div');div.className='time';div.style.height='var(--hour-height)';div.textContent=pad(h)+':00';timecol.appendChild(div)}}function renderDayGrids(){const days=gridEl.querySelectorAll('.daygrid');days.forEach((col)=>{col.innerHTML='';for(let h=0;h<24;h++){const slot=document.createElement('div');slot.className='slot';slot.style.top=`${h*HOUR_PX}px`;col.appendChild(slot);const half=document.createElement('div');half.className='slot half';half.style.top=`${h*HOUR_PX+HOUR_PX/2}px`;col.appendChild(half)}col.addEventListener('click',onGridClick)});renderNowLine()}function renderNowLine(){const now=new Date(),inWeek=dateKeyLocal(startOfWeek(now))===dateKeyLocal(state.weekStart);document.querySelectorAll('.nowline').forEach(e=>e.remove());if(!inWeek)return;const dayIndex=(now.getDay()+6)%7,col=gridEl.querySelector(`.daygrid[data-day="${dayIndex}"]`);if(!col)return;const m=minutesSinceMidnight(now),line=document.createElement('div');line.className='nowline';line.style.top=`${yFromMinutes(m)}px`;col.appendChild(line)}function formatTime(d){return pad(d.getHours())+':'+pad(d.getMinutes())}function formatTimeShort(d){return d.getHours()+':'+pad(d.getMinutes())}function eventSubtitle(s,e,evt){const es=new Date(evt.start),ee=new Date(evt.end),multi=dateKeyLocal(es)!==dateKeyLocal(ee);let txt=multi?`${formatTime(es)} – ${formatTime(ee)}`:`${formatTime(s)} – ${formatTime(e)}`;if(evt.location)txt+=` · ${escapeHtml(evt.location)}`;return txt}function locationSuffix(evt){return evt.location?` · ${escapeHtml(evt.location)}`:''}function renderEvents(){gridEl.querySelectorAll('.event').forEach(e=>e.remove());const wS=new Date(state.weekStart),wE=new Date(wS);wE.setDate(wE.getDate()+7);const segs=[];state.events.forEach(evt=>{const es=new Date(evt.start),ee=new Date(evt.end);if(ee<=wS||es>=wE)return;for(let i=0;i<7;i++){const dS=new Date(wS);dS.setDate(dS.getDate()+i);const dE=new Date(dS);dE.setDate(dE.getDate()+1);const s=new Date(Math.max(es,dS)),e=new Date(Math.min(ee,dE));if(s<e)segs.push({evtId:evt.id,evt,s,e,dayIndex:i,isFirst:s.getTime()===es.getTime(),isLast:e.getTime()===ee.getTime(),offsetFromStartMin:Math.round((s-es)/60000)})}});segs.sort((A,B)=>{const ds=A.s-B.s;if(ds!==0)return ds;return(B.e-B.s)-(A.e-A.s)});const hints={},groups={};segs.forEach(seg=>{const k=`${seg.dayIndex}|${minutesSinceMidnight(seg.s)}`;(groups[k]||=([])).push(seg)});Object.values(groups).forEach(arr=>{if(arr.length===1)return;if(arr.length===2){const[a,b]=arr,dA=(a.e-a.s),dB=(b.e-b.s);if(Math.abs(dA-dB)<1){hints[a.evtId+dateKeyLocal(a.s)]={left:'6px',width:'calc(50% - 9px)'};hints[b.evtId+dateKeyLocal(b.s)]={left:'calc(50% + 3px)',width:'calc(50% - 9px)'}}else{const sh=dA<dB?a:b;hints[sh.evtId+dateKeyLocal(sh.s)]={left:'calc(50% + 3px)',width:'calc(50% - 9px)'}}}else{const n=arr.length;arr.forEach((seg,i)=>{hints[seg.evtId+dateKeyLocal(seg.s)]={left:`calc(${(100/n)*i}% + 6px)`,width:`calc(${100/n}% - 12px)`}})}});segs.forEach(seg=>{const col=gridEl.querySelector(`.daygrid[data-day="${seg.dayIndex}"]`);if(!col)return;const top=yFromMinutes(minutesSinceMidnight(seg.s)),endMin=(minutesSinceMidnight(seg.e)===0?1440:minutesSinceMidnight(seg.e)),height=Math.max(18,yFromMinutes(endMin)-top),el=document.createElement('div');el.className='event';el.style.top=`${top}px`;el.style.height=`${height}px`;el.dataset.id=seg.evtId;el.dataset.segdate=dateKeyLocal(seg.s);el.innerHTML=`<div class="title-row"><div class="title">${escapeHtml(seg.evt.title)}</div><span class="time-inline"></span></div><div class="subtitle">${eventSubtitle(seg.s,seg.e,seg.evt)}</div>`;const hint=hints[seg.evtId+dateKeyLocal(seg.s)];if(hint){el.style.right='auto';el.style.left=hint.left;el.style.width=hint.width}else{el.style.left='6px';el.style.right='6px'}if(state.selectedId===seg.evtId)el.classList.add('selected');el.addEventListener('click',ev=>{ev.stopPropagation();selectEvent(seg.evtId)});el.addEventListener('dblclick',ev=>{ev.stopPropagation();openEdit(seg.evtId)});el.addEventListener('contextmenu',ev=>{ev.preventDefault();ev.stopPropagation();openEdit(seg.evtId)});setupDrag(el,seg.evt,seg);col.appendChild(el);{const dur=Math.round((new Date(seg.evt.end)-new Date(seg.evt.start))/60000),ti=el.querySelector('.time-inline'),su=el.querySelector('.subtitle');if(dur===15){ti&&(ti.textContent=formatTimeShort(new Date(seg.evt.start)));su&&(su.textContent='');el.classList.add('short15')}else el.classList.remove('short15')}});applySelectionDom()}function escapeHtml(s){const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};return String(s).replace(/[&<>"']/g,c=>map[c])}function uid(){return String(Date.now())+Math.random().toString(36).slice(2)}function selectEvent(id){state.selectedId=id;applySelectionDom()}function clearSelection(){state.selectedId=null;applySelectionDom()}function applySelectionDom(){document.querySelectorAll('.event').forEach(el=>{el.dataset.id===String(state.selectedId)?el.classList.add('selected'):el.classList.remove('selected')})}function selectNearestAfterDeletion(deleted){if(!deleted||!state.events.length){state.selectedId=null;render();return}const t=new Date(deleted.start).getTime();let best=null,diff=Infinity;for(const e of state.events){const tt=new Date(e.start).getTime(),d=Math.abs(tt-t);if(best===null||d<diff||(d===diff&&new Date(e.start)<new Date(best.start))){best=e;diff=d}}state.selectedId=best?best.id:null;render()}function render(){renderToolbar();renderHeaders();renderTimeColumn();renderDayGrids();renderEvents()}function onGridClick(e){if(e.target.closest('.event'))return;if(state.selectedId){clearSelection();return}const col=e.currentTarget,rect=col.getBoundingClientRect(),y=e.clientY-rect.top;let minutes=Math.max(0,Math.min(1439,snap(Math.floor(y/HOUR_PX*60))));const dayIndex=Number(col.dataset.day),date=new Date(state.weekStart);date.setDate(date.getDate()+dayIndex);const start=new Date(date);start.setHours(0,0,0,0);start.setMinutes(minutes);const end=new Date(start);end.setMinutes(start.getMinutes()+60);openCreate({start,end})}document.getElementById('prevWeek')?.addEventListener('click',()=>{state.weekStart.setDate(state.weekStart.getDate()-7);render()});document.getElementById('nextWeek')?.addEventListener('click',()=>{state.weekStart.setDate(state.weekStart.getDate()+7);render()});document.getElementById('todayBtn')?.addEventListener('click',()=>{state.weekStart=startOfWeek(new Date());render()});document.getElementById('addEvent')?.addEventListener('click',()=>{const d=new Date(state.weekStart),s=new Date(d);s.setHours(9,0,0,0);const e=new Date(d);e.setHours(10,0,0,0);openCreate({start:s,end:e})});setInterval(renderNowLine,60*1000);gridEl.addEventListener('click',e=>{if(!e.target.closest('.event')&&!e.target.closest('.daygrid'))clearSelection()});document.addEventListener('keydown',e=>{if(dialog.open)return;const ae=document.activeElement,tag=ae&&ae.tagName;if(tag==='INPUT'||tag==='TEXTAREA'||(ae&&ae.isContentEditable))return;if(e.key==='Escape'){clearSelection();return}if(!state.selectedId)return;if(e.key==='Backspace'||e.key==='Delete'){e.preventDefault();const deleted=state.events.find(ev=>ev.id===state.selectedId);state.events=state.events.filter(ev=>ev.id!==state.selectedId);saveEvents();selectNearestAfterDeletion(deleted);return}if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='c'){e.preventDefault();const evt=state.events.find(ev=>ev.id===state.selectedId);if(evt)state.clipboard={...evt};return}if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='v'){if(!state.clipboard)return;e.preventDefault();const copy={...state.clipboard,id:uid()};state.events.push(copy);saveEvents();state.selectedId=copy.id;render()}});function setupDrag(el,evt,seg){const EDGE_PX=16;el.addEventListener('mousemove',mv=>{const r=el.getBoundingClientRect(),y=mv.clientY-r.top,atTop=y<=EDGE_PX&&seg.isFirst,atBot=r.height-y<=EDGE_PX&&seg.isLast;el.classList.toggle('edge-top',atTop);el.classList.toggle('edge-bottom',atBot);el.style.cursor=(atTop||atBot)?'ns-resize':'grab'});el.addEventListener('mouseleave',()=>{el.classList.remove('edge-top','edge-bottom');el.style.cursor=''});el.addEventListener('mousedown',downEvt=>{const r=el.getBoundingClientRect(),y=downEvt.clientY-r.top,atTop=y<=EDGE_PX&&seg.isFirst,atBot=r.height-y<=EDGE_PX&&seg.isLast;if(atTop){startResize(el,evt,seg,'top',downEvt);return}if(atBot){startResize(el,evt,seg,'bottom',downEvt);return}const sx=downEvt.clientX,sy=downEvt.clientY;function onMoveCheck(ev){if(Math.abs(ev.clientX-sx)>3||Math.abs(ev.clientY-sy)>3){document.removeEventListener('mousemove',onMoveCheck);document.removeEventListener('mouseup',onUpCheck);startMove(el,evt,seg,downEvt)}}function onUpCheck(){document.removeEventListener('mousemove',onMoveCheck);document.removeEventListener('mouseup',onUpCheck)}document.addEventListener('mousemove',onMoveCheck);document.addEventListener('mouseup',onUpCheck)})}function startMove(el,evt,seg,downEvt){downEvt.preventDefault();const startRect=el.getBoundingClientRect(),es=new Date(evt.start),ee=new Date(evt.end),duration=Math.round((ee-es)/60000),clickOffsetMin=Math.floor(((downEvt.clientY-startRect.top))/HOUR_PX*60),segOffsetFromStart=seg.offsetFromStartMin;el.classList.add('dragging');el.style.pointerEvents='none';function onMove(ev){const targetCol=document.elementFromPoint(ev.clientX,ev.clientY)?.closest('.daygrid');if(!targetCol)return;const rect=targetCol.getBoundingClientRect();let y=ev.clientY-rect.top;let segTopMin=snap(Math.floor(y/HOUR_PX*60)-clickOffsetMin);const dayIndex=Number(targetCol.dataset.day),dayDate=new Date(state.weekStart);dayDate.setDate(dayDate.getDate()+dayIndex);const newStart=dateFromDayAndMinutes(dayDate,segTopMin-segOffsetFromStart),newEnd=new Date(newStart);newEnd.setMinutes(newStart.getMinutes()+duration);if(el.parentElement!==targetCol)targetCol.appendChild(el);el.style.top=`${yFromMinutes(segTopMin)}px`;const dayStart=new Date(dayDate);dayStart.setHours(0,0,0,0);const dayEnd=new Date(dayStart);dayEnd.setDate(dayEnd.getDate()+1);const segS=new Date(Math.max(newStart,dayStart)),segE=new Date(Math.min(newEnd,dayEnd));const multi=dateKeyLocal(es)!==dateKeyLocal(newEnd),txt=multi?`${formatTime(es)} – ${formatTime(newEnd)}${locationSuffix(evt)}`:`${formatTime(segS)} – ${formatTime(segE)}${locationSuffix(evt)}`,ti=el.querySelector('.time-inline'),su=el.querySelector('.subtitle'),dur=Math.round((newEnd-newStart)/60000);if(dur===15){ti&&(ti.textContent=formatTimeShort(newStart));su&&(su.textContent='');el.classList.add('short15')}else{ti&&(ti.textContent='');su&&(su.textContent=txt);el.classList.remove('short15')}el._tmpStart=newStart;el._tmpEnd=newEnd}function onUp(){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);el.classList.remove('dragging');el.style.pointerEvents='';const ns=el._tmpStart,ne=el._tmpEnd;delete el._tmpStart;delete el._tmpEnd;if(ns&&ne){const i=state.events.findIndex(x=>x.id===evt.id);if(i>-1){state.events[i]={...state.events[i],start:ns.toISOString(),end:ne.toISOString()};saveEvents();renderEvents()}}else renderEvents()}document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onUp)}function startResize(el,evt,seg,edge,downEvt){downEvt.preventDefault();const es=new Date(evt.start),ee=new Date(evt.end);el.classList.add('dragging');el.style.pointerEvents='none';function onMove(ev){const col=el.parentElement,rect=col.getBoundingClientRect();let y=ev.clientY-rect.top,m=snap(Math.floor(y/HOUR_PX*60));const dayIndex=Number(col.dataset.day),dayDate=new Date(state.weekStart);dayDate.setDate(dayDate.getDate()+dayIndex);if(edge==='top'&&seg.isFirst){const ns=dateFromDayAndMinutes(dayDate,m);if(ns<ee&&(ee-ns)>=SNAP_MIN*60000){el.style.top=`${yFromMinutes(m)}px`;const endMinAdj=(minutesSinceMidnight(seg.e)===0?1440:minutesSinceMidnight(seg.e));el.style.height=`${yFromMinutes(endMinAdj)-yFromMinutes(m)}px`;el._tmpStart=ns;el._tmpEnd=ee;const dayStart=new Date(dayDate);dayStart.setHours(0,0,0,0);const dayEnd=new Date(dayStart);dayEnd.setDate(dayEnd.getDate()+1);const segS=new Date(Math.max(ns,dayStart)),segE=new Date(Math.min(ee,dayEnd)),multi=dateKeyLocal(es)!==dateKeyLocal(ee),txt=multi?`${formatTime(es)} – ${formatTime(ee)}${locationSuffix(evt)}`:`${formatTime(segS)} – ${formatTime(segE)}${locationSuffix(evt)}`,ti=el.querySelector('.time-inline'),su=el.querySelector('.subtitle'),dur=Math.round((ee-ns)/60000);if(dur===15){ti&&(ti.textContent=formatTimeShort(ns));su&&(su.textContent='');el.classList.add('short15')}else{ti&&(ti.textContent='');su&&(su.textContent=txt);el.classList.remove('short15')}}}else if(edge==='bottom'&&seg.isLast){const ne=dateFromDayAndMinutes(dayDate,m);if(ne>es&&(ne-es)>=SNAP_MIN*60000){const segTopMin=minutesSinceMidnight(seg.s);el.style.height=`${yFromMinutes(m-segTopMin)}px`;el._tmpStart=es;el._tmpEnd=ne;const dayStart=new Date(dayDate);dayStart.setHours(0,0,0,0);const dayEnd=new Date(dayStart);dayEnd.setDate(dayEnd.getDate()+1);const segS=new Date(Math.max(es,dayStart)),segE=new Date(Math.min(ne,dayEnd)),multi=dateKeyLocal(es)!==dateKeyLocal(ne),txt=multi?`${formatTime(es)} – ${formatTime(ne)}${locationSuffix(evt)}`:`${formatTime(segS)} – ${formatTime(segE)}${locationSuffix(evt)}`,ti=el.querySelector('.time-inline'),su=el.querySelector('.subtitle'),dur=Math.round((ne-es)/60000);if(dur===15){ti&&(ti.textContent=formatTimeShort(es));su&&(su.textContent='');el.classList.add('short15')}else{ti&&(ti.textContent='');su&&(su.textContent=txt);el.classList.remove('short15')}}}}function onUp(){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);el.classList.remove('dragging');el.style.pointerEvents='';const ns=el._tmpStart||es,ne=el._tmpEnd||ee;delete el._tmpStart;delete el._tmpEnd;if(ns!==es||ne!==ee){const i=state.events.findIndex(x=>x.id===evt.id);if(i>-1){state.events[i]={...state.events[i],start:ns.toISOString(),end:ne.toISOString()};saveEvents();renderEvents()}}}document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onUp)}const dialog=document.getElementById('eventDialog'),form=document.getElementById('eventForm'),deleteBtn=document.getElementById('deleteBtn'),saveBtn=document.getElementById('saveBtn');let deleteConfirmTimer=null;function resetDeleteBtn(){if(!deleteBtn)return;deleteBtn.dataset.confirm='';deleteBtn.textContent='Delete';deleteBtn.classList.remove('confirm');if(deleteConfirmTimer){clearTimeout(deleteConfirmTimer);deleteConfirmTimer=null}}const qs=id=>{const el=document.getElementById(id);if(!el)console.error('#'+id+' not found');return el},getFormEls=()=>({titleInput:qs('title'),locationInput:qs('location'),startDTInput:qs('startDT'),endDTInput:qs('endDT'),descInput:qs('description')});function openCreate({start,end}){state.editingId=null;resetDeleteBtn();deleteBtn.style.display='none';const {titleInput,locationInput,startDTInput,endDTInput,descInput}=getFormEls();if(!titleInput||!startDTInput||!endDTInput)return;titleInput.value='';locationInput.value='';descInput.value='';startDTInput.value=toLocalInputValue(start);endDTInput.value=toLocalInputValue(end);if(saveBtn)saveBtn.textContent='Create meeting';dialog.showModal()}function openEdit(id){const evt=state.events.find(e=>e.id===id);if(!evt)return;state.editingId=id;resetDeleteBtn();deleteBtn.style.display='inline-block';const {titleInput,locationInput,startDTInput,endDTInput,descInput}=getFormEls();if(!titleInput||!startDTInput||!endDTInput)return;titleInput.value=evt.title||'';locationInput.value=evt.location||'';descInput.value=evt.description||'';const s=new Date(evt.start),e=new Date(evt.end);startDTInput.value=toLocalInputValue(s);endDTInput.value=toLocalInputValue(e);if(saveBtn)saveBtn.textContent='Save changes';dialog.showModal()}deleteBtn.addEventListener('click',()=>{if(state.editingId!=null){if(deleteBtn.dataset.confirm==='true'){const deleted=state.events.find(e=>e.id===state.editingId);state.events=state.events.filter(e=>e.id!==state.editingId);saveEvents();dialog.close();resetDeleteBtn();selectNearestAfterDeletion(deleted)}else{deleteBtn.dataset.confirm='true';deleteBtn.textContent='Are you sure?';deleteBtn.classList.add('confirm');if(deleteConfirmTimer)clearTimeout(deleteConfirmTimer);deleteConfirmTimer=setTimeout(()=>{resetDeleteBtn()},3000)}}});form.addEventListener('submit',ev=>{ev.preventDefault();const {titleInput,locationInput,startDTInput,endDTInput,descInput}=getFormEls();if(!titleInput||!startDTInput||!endDTInput)return;const title=titleInput.value.trim()||'Untitled',location=(locationInput?.value||'').trim(),description=(descInput?.value||'').trim(),start=new Date(startDTInput.value);let end=new Date(endDTInput.value);if(!(start instanceof Date)||isNaN(start))return;if(!(end instanceof Date)||isNaN(end))end=new Date(start);if(end<=start){end=new Date(start);end.setMinutes(start.getMinutes()+30)}if(state.editingId==null){state.events.push({id:uid(),title,location,description,start:start.toISOString(),end:end.toISOString()})}else{const i=state.events.findIndex(e=>e.id===state.editingId);if(i>-1)state.events[i]={...state.events[i],title,location,description,start:start.toISOString(),end:end.toISOString()}}saveEvents();render();dialog.close()});document.getElementById('closeBtn')?.addEventListener('click',()=>dialog.close());dialog.addEventListener('mousedown',e=>{const r=form.getBoundingClientRect(),inside=e.clientX>=r.left&&e.clientX<=r.right&&e.clientY>=r.top&&e.clientY<=r.bottom;if(!inside)dialog.close()});dialog.addEventListener('close',resetDeleteBtn);(function(){console.assert(escapeHtml('<>&"\'\'')==='&lt;&gt;&amp;&quot;&#039;&#039;','escapeHtml');console.assert(snap(7)===Math.round(7/15)*15,'snap');console.assert(dateKeyLocal(new Date('2025-01-02T03:04:00')).split('-').length===3,'dateKeyLocal');console.assert((()=>{const s=new Date('2025-08-14T22:00:00'),e=new Date('2025-08-15T00:00:00');const raw=e.getHours()*60+e.getMinutes(),endMin=(raw===0?1440:raw);return endMin===1440})(),'midnight end');console.assert(!!document.getElementById('prevWeek'),'#prevWeek');console.assert(!!document.getElementById('todayBtn'),'#todayBtn');console.assert(!!document.getElementById('nextWeek'),'#nextWeek');['title','startDT','endDT','location','description'].forEach(id=>console.assert(!!document.getElementById(id),'#'+id+' exists'));console.assert(locationSuffix({location:'Office'})===' · Office','loc suffix');console.assert(locationSuffix({})==='','loc empty');const evtTest={start:'2025-08-14T06:45:00',end:'2025-08-15T09:15:00'},sub=eventSubtitle(new Date('2025-08-14T06:45:00'),new Date('2025-08-14T23:59:00'),evtTest);console.assert(sub.startsWith('06:45 – 09:15'),'multi-day');console.assert(typeof uid()==='string'&&uid().length>10,'uid ok');state.selectedId='x';clearSelection();console.assert(state.selectedId===null,'clearSelection');const bakEv=state.events.slice(),bakSel=state.selectedId;state.events=[{id:'a',start:'2025-01-01T10:00:00',end:'2025-01-01T11:00:00'},{id:'b',start:'2025-01-01T10:30:00',end:'2025-01-01T11:00:00'},{id:'c',start:'2025-01-01T09:00:00',end:'2025-01-01T09:15:00'}];selectNearestAfterDeletion({id:'x',start:'2025-01-01T10:20:00',end:'2025-01-01T10:35:00'});console.assert(state.selectedId==='b','nearest after delete picks closest');state.events=bakEv;state.selectedId=bakSel;render()})();render()});</script></body></html>
